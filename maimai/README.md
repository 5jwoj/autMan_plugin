# 麦当劳优惠券插件

[![版本](https://img.shields.io/badge/version-1.0.0-blue.svg)](https://github.com/5jwoj/autMan_plugin)
[![许可证](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

基于麦当劳 MCP Server API 的优惠券管理插件，支持活动日历查询、优惠券领取、多账号管理和定时自动领券。

## ✨ 功能特性

- ✅ **活动日历查询** - 查看麦当劳最新活动和促销信息
- ✅ **优惠券管理** - 查看可领优惠券和已领优惠券
- ✅ **一键领券** - 自动领取所有可用优惠券
- ✅ **多账号管理** - 支持添加多个 MCP 账号并自由切换
- ✅ **定时自动领券** - 每天自动领取新优惠券（可开关）
- ✅ **完整的 MCP 协议支持** - 实现 JSON-RPC 2.0 和 SSE 响应处理

## 📋 系统要求

- **autMan**: 支持 JavaScript 插件和定时任务的版本
- **网络**: 需要访问麦当劳 MCP Server API
- **MCP Token**: 从 [麦当劳开放平台](https://open.mcd.cn/mcp/doc) 获取

## 🚀 快速开始

### 1. 安装插件

```bash
# 下载插件文件
wget https://raw.githubusercontent.com/5jwoj/autMan_plugin/main/maimai/麦当劳优惠券.js

# 上传到 autMan 服务器
scp 麦当劳优惠券.js root@服务器:/root/aut/plugin/replies/

# 重启 autMan
systemctl restart autman
```

### 2. 获取 MCP Token

1. 访问 [麦当劳开放平台](https://open.mcd.cn/mcp/doc)
2. 注册并登录账号
3. 创建应用并获取 MCP Token
4. 复制 Token 备用

### 3. 添加账号

在微信中发送：

```
麦当劳 添加账号 我的账号 YOUR_MCP_TOKEN
```

将 `YOUR_MCP_TOKEN` 替换为您的实际 Token。

### 4. 开始使用

```
麦当劳              # 显示主菜单
麦当劳 优惠券       # 查看可领优惠券
麦当劳 领券         # 一键领取所有优惠券
```

## 📖 使用说明

### 基础命令

| 命令 | 说明 |
|------|------|
| `麦当劳` | 显示主菜单和账号状态 |
| `麦当劳 帮助` | 显示完整帮助信息 |

### 优惠券功能

| 命令 | 说明 |
|------|------|
| `麦当劳 日历` | 查看活动日历 |
| `麦当劳 优惠券` | 查看可领优惠券列表 |
| `麦当劳 领券` | 一键领取所有可用优惠券 |
| `麦当劳 我的优惠券` | 查看已领取的优惠券 |

### 账号管理

| 命令 | 说明 |
|------|------|
| `麦当劳 添加账号 <名称> <Token>` | 添加新账号 |
| `麦当劳 切换账号 <名称>` | 切换到指定账号 |
| `麦当劳 账号列表` | 查看所有账号 |
| `麦当劳 删除账号 <名称>` | 删除指定账号 |

**示例**：

```
麦当劳 添加账号 主账号 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
麦当劳 添加账号 小号 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
麦当劳 切换账号 小号
麦当劳 账号列表
```

### 自动领券

| 命令 | 说明 |
|------|------|
| `麦当劳 开启自动领券` | 开启每日自动领券（09:00） |
| `麦当劳 关闭自动领券` | 关闭自动领券 |
| `麦当劳 状态` | 查看账号和自动领券状态 |

**自动领券说明**：
- 每天 **09:00** 自动执行
- 仅对开启自动领券的用户生效
- 每天每账号仅领取一次
- 领取成功后会发送通知消息

## 🎯 使用场景

### 场景一：日常查询优惠券

```
用户: 麦当劳 优惠券
机器人: 🔍 正在查询可领优惠券...
机器人: 🎫 可领优惠券
       ━━━━━━━━━━━━━━━
       
       1. 麦辣鸡腿堡套餐 - 19.9元
       2. 麦香鱼套餐 - 18.9元
       ...
```

### 场景二：一键领取优惠券

```
用户: 麦当劳 领券
机器人: 🎁 正在领取优惠券...
机器人: ✅ 领券结果
       ━━━━━━━━━━━━━━━
       
       成功领取 5 张优惠券
       失败 0 张
       重复 2 张
```

### 场景三：多账号管理

```
用户: 麦当劳 账号列表
机器人: 👤 账号列表
       ━━━━━━━━━━━━━━━
       
       ✅ 主账号 (当前)
       　 小号
       　 家人账号
       
       发送「麦当劳 切换账号 名称」切换账号

用户: 麦当劳 切换账号 小号
机器人: ✅ 已切换到账号「小号」
```

### 场景四：自动领券

```
用户: 麦当劳 开启自动领券
机器人: ✅ 自动领券已开启
       
       每天 09:00 自动领取优惠券

# 第二天 09:00
机器人: 🎁 自动领券成功
       ━━━━━━━━━━━━━━━
       
       成功领取 3 张优惠券
       ...
```

## 🔧 技术实现

### MCP 协议支持

本插件完整实现了麦当劳 MCP Server 的通信协议：

- **JSON-RPC 2.0** - 标准的 RPC 协议
- **SSE (Server-Sent Events)** - 服务器推送事件流
- **会话管理** - 自动维护 Session ID
- **错误处理** - 完善的错误重试机制

### 数据存储

使用 autMan 存储桶系统：

```javascript
// 用户数据结构
{
  "accounts": {
    "主账号": {
      "token": "eyJhbGci...",
      "label": "主账号",
      "createdAt": "2026-01-17T10:00:00.000Z"
    }
  },
  "activeAccount": "主账号",
  "autoClaimEnabled": true,
  "lastClaimDate": "2026-01-17"
}
```

### 定时任务

使用 autMan 的 Cron 功能：

```javascript
//[cron:0 9 * * *]  // 每天 09:00 执行
```

## ❓ 常见问题

### Q: 如何获取 MCP Token？

A: 访问 [麦当劳开放平台](https://open.mcd.cn/mcp/doc)，注册账号后创建应用即可获取。

### Q: 可以添加多个账号吗？

A: 可以！插件支持多账号管理，您可以为家人添加多个账号，随时切换使用。

### Q: 自动领券会重复领取吗？

A: 不会。插件会记录每天的领取状态，每个账号每天只会自动领取一次。

### Q: Token 安全吗？

A: Token 存储在 autMan 的存储桶中，仅您本人可见，不会泄露给其他用户。

### Q: 领券失败怎么办？

A: 可能的原因：
1. Token 已过期 - 重新获取 Token
2. 网络问题 - 稍后重试
3. 优惠券已领完 - 等待新优惠券上线

### Q: 可以修改自动领券时间吗？

A: 当前固定为每天 09:00，如需修改请编辑插件文件中的 `//[cron:0 9 * * *]` 行。

## 🔄 更新日志

### v1.0.0 (2026-01-17)

- ✨ 首次发布
- ✅ 支持活动日历查询
- ✅ 支持优惠券查询和领取
- ✅ 支持多账号管理
- ✅ 支持定时自动领券
- ✅ 完整的 MCP 协议实现

## 📝 开发说明

### 插件结构

```
maimai/
├── 麦当劳优惠券.js    # 主插件文件
└── README.md          # 使用文档
```

### 核心模块

1. **MCP 客户端** - 实现 MCP 协议通信
2. **账号管理** - 多账号存储和切换
3. **工具调用** - 封装 MCP 工具调用
4. **命令处理** - 解析和路由用户命令
5. **定时任务** - 自动领券调度

### 扩展开发

如需添加新功能，可以参考以下接口：

```javascript
// 调用 MCP 工具
client.callTool(toolName, args, function(error, result) {
  // 处理结果
});

// 用户数据管理
var userData = getUserData(userId);
saveUserData(userId, userData);
```

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License - 详见 [LICENSE](../LICENSE)

## 🔗 相关链接

- [autMan 插件集合](https://github.com/5jwoj/autMan_plugin)
- [麦当劳开放平台](https://open.mcd.cn/mcp/doc)
- [MCP 协议文档](https://modelcontextprotocol.io/)

---

**Made with ❤️ by [5jwoj](https://github.com/5jwoj)**
